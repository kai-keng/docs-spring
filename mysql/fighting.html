<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL 实战45讲学习笔记 | Java</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Just record my learning process">
    <link rel="preload" href="/java-learning/assets/css/0.styles.dcc29016.css" as="style"><link rel="preload" href="/java-learning/assets/js/app.64004742.js" as="script"><link rel="preload" href="/java-learning/assets/js/2.a87b479c.js" as="script"><link rel="preload" href="/java-learning/assets/js/20.9c74ec8b.js" as="script"><link rel="prefetch" href="/java-learning/assets/js/10.52a08a19.js"><link rel="prefetch" href="/java-learning/assets/js/11.5985491b.js"><link rel="prefetch" href="/java-learning/assets/js/12.a8cfbbfc.js"><link rel="prefetch" href="/java-learning/assets/js/13.289bbd1c.js"><link rel="prefetch" href="/java-learning/assets/js/14.c7436ad7.js"><link rel="prefetch" href="/java-learning/assets/js/15.17e3a702.js"><link rel="prefetch" href="/java-learning/assets/js/16.4dfa3b71.js"><link rel="prefetch" href="/java-learning/assets/js/17.a5c39e0c.js"><link rel="prefetch" href="/java-learning/assets/js/18.940061f4.js"><link rel="prefetch" href="/java-learning/assets/js/19.4d192b02.js"><link rel="prefetch" href="/java-learning/assets/js/21.70b878d8.js"><link rel="prefetch" href="/java-learning/assets/js/22.abd2272c.js"><link rel="prefetch" href="/java-learning/assets/js/23.5fa0a758.js"><link rel="prefetch" href="/java-learning/assets/js/24.b068e938.js"><link rel="prefetch" href="/java-learning/assets/js/25.c4480689.js"><link rel="prefetch" href="/java-learning/assets/js/26.e07f4665.js"><link rel="prefetch" href="/java-learning/assets/js/27.d8f2b613.js"><link rel="prefetch" href="/java-learning/assets/js/28.c2bdaeab.js"><link rel="prefetch" href="/java-learning/assets/js/29.62c1a766.js"><link rel="prefetch" href="/java-learning/assets/js/3.01cd8f00.js"><link rel="prefetch" href="/java-learning/assets/js/30.9d53aeb9.js"><link rel="prefetch" href="/java-learning/assets/js/31.cea99a16.js"><link rel="prefetch" href="/java-learning/assets/js/32.6965d105.js"><link rel="prefetch" href="/java-learning/assets/js/33.70793364.js"><link rel="prefetch" href="/java-learning/assets/js/34.307dd6f5.js"><link rel="prefetch" href="/java-learning/assets/js/35.dbfb4b31.js"><link rel="prefetch" href="/java-learning/assets/js/36.39c7fc52.js"><link rel="prefetch" href="/java-learning/assets/js/37.eb542229.js"><link rel="prefetch" href="/java-learning/assets/js/38.e8fa0aff.js"><link rel="prefetch" href="/java-learning/assets/js/39.cead4bfa.js"><link rel="prefetch" href="/java-learning/assets/js/4.148d2f7b.js"><link rel="prefetch" href="/java-learning/assets/js/40.c8a167fb.js"><link rel="prefetch" href="/java-learning/assets/js/41.2a4dceb8.js"><link rel="prefetch" href="/java-learning/assets/js/42.a632005a.js"><link rel="prefetch" href="/java-learning/assets/js/43.66f6d96d.js"><link rel="prefetch" href="/java-learning/assets/js/44.9ec07c82.js"><link rel="prefetch" href="/java-learning/assets/js/45.a59e8f1f.js"><link rel="prefetch" href="/java-learning/assets/js/46.71249238.js"><link rel="prefetch" href="/java-learning/assets/js/47.54940450.js"><link rel="prefetch" href="/java-learning/assets/js/48.0e99fbfc.js"><link rel="prefetch" href="/java-learning/assets/js/49.a65b263a.js"><link rel="prefetch" href="/java-learning/assets/js/5.9ab74f2e.js"><link rel="prefetch" href="/java-learning/assets/js/50.f4015099.js"><link rel="prefetch" href="/java-learning/assets/js/51.8bb7ac9b.js"><link rel="prefetch" href="/java-learning/assets/js/52.7ab2fad6.js"><link rel="prefetch" href="/java-learning/assets/js/53.81e0a76d.js"><link rel="prefetch" href="/java-learning/assets/js/54.293dfba9.js"><link rel="prefetch" href="/java-learning/assets/js/55.d395eea2.js"><link rel="prefetch" href="/java-learning/assets/js/56.a223a86e.js"><link rel="prefetch" href="/java-learning/assets/js/57.b2354a36.js"><link rel="prefetch" href="/java-learning/assets/js/58.cfaa6432.js"><link rel="prefetch" href="/java-learning/assets/js/59.3b48f80b.js"><link rel="prefetch" href="/java-learning/assets/js/6.28727936.js"><link rel="prefetch" href="/java-learning/assets/js/60.c0c4619e.js"><link rel="prefetch" href="/java-learning/assets/js/61.741ecff3.js"><link rel="prefetch" href="/java-learning/assets/js/62.1d479a99.js"><link rel="prefetch" href="/java-learning/assets/js/63.5b554abf.js"><link rel="prefetch" href="/java-learning/assets/js/64.5f6e0891.js"><link rel="prefetch" href="/java-learning/assets/js/65.68964080.js"><link rel="prefetch" href="/java-learning/assets/js/66.6c8a3ac8.js"><link rel="prefetch" href="/java-learning/assets/js/67.5a3e0bb3.js"><link rel="prefetch" href="/java-learning/assets/js/68.0cadbad7.js"><link rel="prefetch" href="/java-learning/assets/js/69.b8a44d9d.js"><link rel="prefetch" href="/java-learning/assets/js/7.ad02449b.js"><link rel="prefetch" href="/java-learning/assets/js/70.d4c204cd.js"><link rel="prefetch" href="/java-learning/assets/js/71.a833f4ef.js"><link rel="prefetch" href="/java-learning/assets/js/72.26e1caec.js"><link rel="prefetch" href="/java-learning/assets/js/73.01f0dd42.js"><link rel="prefetch" href="/java-learning/assets/js/74.2fa53582.js"><link rel="prefetch" href="/java-learning/assets/js/75.7163a2b6.js"><link rel="prefetch" href="/java-learning/assets/js/76.945bee10.js"><link rel="prefetch" href="/java-learning/assets/js/77.c355f10d.js"><link rel="prefetch" href="/java-learning/assets/js/78.1d5be737.js"><link rel="prefetch" href="/java-learning/assets/js/79.6a70fb36.js"><link rel="prefetch" href="/java-learning/assets/js/8.2f1d2c03.js"><link rel="prefetch" href="/java-learning/assets/js/80.c4aeb058.js"><link rel="prefetch" href="/java-learning/assets/js/81.be26e42a.js"><link rel="prefetch" href="/java-learning/assets/js/9.6a16f59a.js">
    <link rel="stylesheet" href="/java-learning/assets/css/0.styles.dcc29016.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/java-learning/" class="home-link router-link-active"><!----> <span class="site-name">Java</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://kai-keng.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://kai-keng.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/spring-boot/" class="sidebar-heading clickable"><span>Spring Boot</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/java-learning/spring-cloud/" class="sidebar-link">Spring Cloud</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/spring-security/" class="sidebar-heading clickable"><span>Spring Security</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/mysql/" class="sidebar-heading clickable router-link-active open"><span>MySQL</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/java-learning/mysql/mysql-index.html" class="sidebar-link">索引</a></li><li><a href="/java-learning/mysql/datatype.html" class="sidebar-link">数据类型</a></li><li><a href="/java-learning/mysql/transaction.html" class="sidebar-link">事务（Transaction）</a></li><li><a href="/java-learning/mysql/explain.html" class="sidebar-link">Explain（执行计划）字段解析</a></li><li><a href="/java-learning/mysql/sql-optimization.html" class="sidebar-link">SQL 优化</a></li><li><a href="/java-learning/mysql/fighting.html" aria-current="page" class="active sidebar-link">MySQL 实战45讲学习笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#_1-mysql-架构" class="sidebar-link">1. MySQL 架构</a></li><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#_2-redolog-与-binlog" class="sidebar-link">2. redolog 与 binlog</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#binlog" class="sidebar-link">binlog</a></li><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#redolog" class="sidebar-link">redolog</a></li><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#关于-crash-safe-能力" class="sidebar-link">关于 crash-safe 能力</a></li><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#两阶段提交" class="sidebar-link">两阶段提交</a></li></ul></li><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#_3-事务隔离" class="sidebar-link">3. 事务隔离</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#事务隔离实现原理" class="sidebar-link">事务隔离实现原理</a></li><li class="sidebar-sub-header"><a href="/java-learning/mysql/fighting.html#解决长事务" class="sidebar-link">解决长事务</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/collection/" class="sidebar-heading clickable"><span>集合框架</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/jvm/" class="sidebar-heading clickable"><span>JVM</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/multi-thread/" class="sidebar-heading clickable"><span>多线程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/design-pattern/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/java-learning/internet/" class="sidebar-link">网络</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/other/" class="sidebar-heading clickable"><span>其他</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/java-learning/materials/" class="sidebar-link">相关资料</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql-实战45讲学习笔记"><a href="#mysql-实战45讲学习笔记" class="header-anchor">#</a> MySQL 实战45讲学习笔记</h1> <h2 id="_1-mysql-架构"><a href="#_1-mysql-架构" class="header-anchor">#</a> 1. MySQL 架构</h2> <p>MySQL 分为两部分：Server 层与存储引擎层。 Server 中含有：连接器、分析器、优化器与执行器，存储引擎层即使用于存储的引擎，其中包含有用于操作数据的接口。</p> <ul><li><p>连接器：用于连接 MySQL，会校验账号与密码。</p></li> <li><p>分析器：用于做词法分析和语法分析，判断输入的 MySQL 语句是否正确。</p></li> <li><p>优化器：用于优化输入的 SQL 语句，选择优化器认为的最优的执行顺序，查询索引等。</p></li> <li><p>执行器：即真正的去调用存储引擎来查询所需要的数据。</p></li></ul> <p>查询缓存：在 MySQL 8.0以前带有查询缓存，即以 key、value 的形式存储我们的查询语句与查询结果。但是不被推荐使用，因为只需要更新表内的任意一条数据，都会导致整张表的缓存删除，导致缓存的命中率低下，只适用于极少更新的表中，故不被推荐使用，并且在 MySQL 8.0以后删除了查询缓存的功能。</p> <h2 id="_2-redolog-与-binlog"><a href="#_2-redolog-与-binlog" class="header-anchor">#</a> 2. redolog 与 binlog</h2> <h3 id="binlog"><a href="#binlog" class="header-anchor">#</a> binlog</h3> <ul><li><strong>介绍</strong></li></ul> <p>binlog 是 MySQL 数据库 Server 层实现的修改日志，记录数据库中原始逻辑操作。</p> <ul><li><strong>特点</strong></li></ul> <ol><li>MySQL 中所有的引擎都有 binlog，是 MySQL 中的Server层实现的</li> <li>binlog 没有定长空间，是追加写入的方式，当写满了的时候可以找下一个空间接着写</li> <li>binlog 是记录逻辑原始逻辑操作，比如 ID = 2 的行修改 c = c + 1</li></ol> <h3 id="redolog"><a href="#redolog" class="header-anchor">#</a> redolog</h3> <ul><li><p><strong>介绍</strong>
在执行器调用存储引擎之后，存储引擎出于效率考虑，并不会立即将数据存入磁盘中，而是先将操作写入 redolog 中，在 redolog 中记录下自己的操作，然后在适当的时间（比如系统空闲时间）将数据写入磁盘。</p></li> <li><p><strong>特点</strong></p></li></ul> <ol><li>redolog 只有 InnoDB 才有，是 InnoDB 自己实现的</li> <li>redolog 是有固定的存储空间的，它有两个指针，分别是 write pos 与 check point， write pos 指针表示当前日志写入到的位置，当指针到末尾以后会回到头部重新开始写入。
而 check point 则表示清除了 redolog 的位置，将 redolog 的内容写入到磁盘中，check point 与 write pos 之间的位置则表示空闲待写入的空间。当 write pos 追上 check point 的时候会停止写入 redolog，
先将记录的 redolog 存入到磁盘中，待有空闲空间以后再继续写入 redolog</li> <li>redolog 记录的是物理操作，比如在某个数据页上，修改了什么数据，更为具体。</li> <li>因为在写入数据进入物理磁盘之前，会先写入 redolog，所以在我们数据库崩溃异常重启的时候，只需要依照我们的 redolog 上的记录来恢复尚未存入到磁盘中的数据，就可以恢复原库数据，这个行为称为 <strong>crash-safe</strong>。</li></ol> <h3 id="关于-crash-safe-能力"><a href="#关于-crash-safe-能力" class="header-anchor">#</a> 关于 crash-safe 能力</h3> <p>看完讲解后我提出一个问题，为什么 binlog 没有 crash-safe 能力？它也记录了事务的操作，我们按照 binlog 的记录直接恢复未存储的数据不就好了吗？</p> <p>查阅一些资料无果之后又仔细多次阅读 MySQL 实战45讲，发现也并没有描述为什么 binlog 不带有 crash-safe 能力，所以在往后继续看两阶段提交的时候，需要在脑中有一个思想，就是 binlog 不带有 carsh-safe
能力，不然你在看两阶段提交的时候会很纳闷，不能理解为什么。</p> <h3 id="两阶段提交"><a href="#两阶段提交" class="header-anchor">#</a> 两阶段提交</h3> <p>假设我们要执行一个修改语句：<code>UPDATE T SET c = c + 1 WHERE ID = 2</code></p> <p>该语句执行的流程图如下：
<img src="/java-learning/assets/img/2-1.2e5bff49.png" alt="执行流程图"></p> <p>图中可以看到，redolog 的写入是分为两阶段的，分别是开始的 prepare 阶段与事务提交后的 commit 阶段。</p> <p>为什么会需要有这两个阶段呢？</p> <p>我们可以使用反证法假设没有两阶段提交，单纯的只是分别写入这两个日志：</p> <ol><li>先写入 redolog 后写入 binlog</li></ol> <p>假设在写入了 redolog 的时候，数据库崩溃了，我们需要使用 redolog 恢复原库，这个时候 redolog 记录 c 的值已经被修改成了 1，我们使用 redolog 的 crash-safe 能力恢复以后库的值即为
1，这个时候 1 即为原库值。但是这个时候 binlog 中还没有写入 c = 1 的操作，如果我们之后使用 binlog 来恢复的话，值就不会等于 1，就与原库值不一致。</p> <ol start="2"><li>先写入 binlog 后写入 redolog</li></ol> <p>假设在写入 binlog 的时候数据库崩溃了，这个时候 binlog 已经记录了 c = 1，但是我们的 redolog 中没有记录下来，使用 crash-safe 恢复库以后，原库值 c = 0，两边又不一致了。</p> <p>而使用两阶段提交的话，我们就能知道当前日志是否同时写入了 redolog 与 binlog 中，能确保两边恢复的数据都一致了。</p> <h2 id="_3-事务隔离"><a href="#_3-事务隔离" class="header-anchor">#</a> 3. 事务隔离</h2> <p>事务隔离是数据库的一个重要特性，能够避免在并行操作的时候读取到我们意料之外的值情况。同时也能够确保在我们进行一系列操作的时候，当某一个操作失败的时候能够将之前的操作也回滚掉，不在数据库中生效。</p> <p>数据库操作主要分为<strong>读操作</strong>和<strong>写操作</strong>。写操作的控制主要是依靠数据库的锁来控制并发下的意外情况，而读操作则依据设置的事务隔离级别不同，会有不同的处理。</p> <p>事务隔离从读的方面来讲，主要目的是为了解决如下几个问题：</p> <p>假设有如下数据：
<code>insert into T(c) values(1);</code></p> <p>假设有事务 A、B，事务 A 优先于事务 B 开启。</p> <ul><li>脏读：读取到其他事务尚未提交的内容。比如在事务 A 中，我修改了 c 的值为2，事务 A 尚未提交，但是事务 B 已经读取到了这个尚未提交的新值。</li> <li>不可重复读：在另一个事务开启期间，重复读取某一行的值，但是读取到的值前后不一致。比如事务 A 第一次读取 c 的值为1，然后事务 B 修改了 c 的值为2并提交，这个时候事务 A 再次读取 c 的值为2，前后读取到的 c 值不一致，此为不可重复读。</li> <li>幻读：在事务开启期间重复读取一张表中的数据总行数，前后读取到的行数不一致。比如事务 A 第一次读取到的表 T 的行数为1，然后事务 B 在表 T 中新增了一行并提交，这个时候事务 A 再次读取表行数为2，前后不一致。</li></ul> <blockquote><p>幻读和不可重复读的主要区别点在与，不可重复读是指某一行数据，前后重复读取的值不相同，而幻读是读取一张表中的行数，前后不一致。不可重复读针对于行的修改，幻读针对的是对表中行数据的新增与删除操作。</p></blockquote> <p>介绍完事务并发读取的几个问题后，我们再谈下不同的事务隔离级别：</p> <ul><li>读未提交：一个事务可以读取到另外一个事务尚未提交的修改。无法解决以上任一问题。</li> <li>读已提交：一个事务只能读取到其他事务已经提交的数据，尚未提交的数据无法读取到。能解决脏读问题。</li> <li>可重复读：一个事务在事务期间读取某一行的值，前后都保持一致，不会出现前后读取到的数据不一致的问题。能解决脏读，不可重复读。</li> <li>串行化：所有的事务都是串行执行，没有并发操作，效率低下，但是能解决以上所有问题。</li></ul> <blockquote><p>ORACLE 默认为读已提交，MySQL 默认为可重复读。</p></blockquote> <h3 id="事务隔离实现原理"><a href="#事务隔离实现原理" class="header-anchor">#</a> 事务隔离实现原理</h3> <p>事务隔离实现的依靠的是<strong>回滚日志</strong>与 <strong>Read-View</strong>。</p> <p>回滚日志记录下了我们的数据值可以从当前值修改回原值的内容，而 Read-View 则是我们数据库中表的快照。</p> <p>比如当我们的事务隔离级别为<strong>可重复读</strong>的时候，我们每开启一个事务都会生成一个 Read-View 的快照，然后在事务执行期间，我们读取的都是这个快照而不是实际的数据库，
这样就保证了我们的事务期间读取到的值都是一致的，不会出现不可重复读的问题。</p> <p>而<strong>读已提交</strong>则是在每次执行 SQL 语句的时候都会生成一个 Read-View，<strong>读未提交</strong>则不会生成 Read-View，所有的操作都是直接作用在表上的。</p> <p>当我们想要回滚数据的时候，我们依靠<strong>回滚日志</strong>与 <strong>Read-View</strong>就可以回滚我们的事务。假设我们的事务隔离级别为<strong>读已提交</strong>，将表 T 中的 c 值依次修改为 2、3、4，那么这个时候事务则会记录如下的<strong>回滚日志</strong>与 <strong>Read-View</strong>。</p> <p><img src="/java-learning/assets/img/2-2.d9c31380.png" alt="回滚日志与 Read-View"></p> <p>当我们想要回滚事务的时候，需要依次从 Read-View C - B - A 按照回滚日志来回滚。</p> <p>那么我们的回滚日志总不可能一直保存着吧？什么时候删除呢？</p> <p>是否删除回滚日志取决于我们是否有比回滚日志更早的 Read-View，当没有更早的 Read-View 的时候就会清理掉回滚日志了。</p> <blockquote><p>至于何时删除 Read-View，MySQL 实战中没讲，我没也查到，猜测事务结束的时候就会清理掉 Read-View 了，但是为什么不在事务结束的时候直接清除掉回滚日志呢？事务结束了不就不需要回滚日志了吗？</p></blockquote> <h3 id="解决长事务"><a href="#解决长事务" class="header-anchor">#</a> 解决长事务</h3> <p>长事务会一直累积回滚日志，增加库的大小，需要尽量避免长事务的出现。</p> <p>如何避免长事务呢？ 个人认为需要做到以下几点：</p> <ol><li>统一项目后端框架，确保我们的框架不会自动运行 set autocommit=0</li> <li>规范开发行为，如无特殊需求禁止使用长事务</li> <li>必要的话可以要求开发全部手动控制整个事务的生命周期，从开启事务到提交、回滚事务都手动编写，不使用框架的自动事务提交</li> <li>CodeReview，检查代码，避免漏提交事务，写错等</li> <li>定期运行 <code>select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now()，trx_started))&gt;60</code> 检查数据库中是否存在长事务</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java-learning/mysql/sql-optimization.html" class="prev">
        SQL 优化
      </a></span> <span class="next"><a href="/java-learning/collection/overview.html">
        概览
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/java-learning/assets/js/app.64004742.js" defer></script><script src="/java-learning/assets/js/2.a87b479c.js" defer></script><script src="/java-learning/assets/js/20.9c74ec8b.js" defer></script>
  </body>
</html>
