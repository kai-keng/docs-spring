(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{462:function(a,t,s){"use strict";s.r(t);var n=s(42),r=Object(n.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"事务管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务管理"}},[a._v("#")]),a._v(" 事务管理")]),a._v(" "),s("h2",{attrs:{id:"事务介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事务介绍"}},[a._v("#")]),a._v(" 事务介绍")]),a._v(" "),s("p",[a._v("事务的概念介绍可以参照"),s("a",{attrs:{href:"https://kai-keng.github.io/java-learning/mysql/transaction.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("MySQL事务"),s("OutboundLink")],1),a._v("。")]),a._v(" "),s("p",[a._v("在日常开发中，我们需要依据我们的业务逻辑，在一些操作失败的时候，对我们的一些事务进行过滚，所以学会事务操作是非常有必要的。")]),a._v(" "),s("h2",{attrs:{id:"spring-boot-中的事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring-boot-中的事务"}},[a._v("#")]),a._v(" Spring Boot 中的事务")]),a._v(" "),s("p",[a._v("在Spring Boot 中，当我们引用了 "),s("strong",[a._v("spring-boot-starter-jdbc")]),a._v(" 或 "),s("strong",[a._v("spring-boot-starter-data-jpa")]),a._v(" 的时候会自动帮我们注入事务管理器，我们使用起来非常简单。")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 只需要在需要添加事务的地方加上 Transactional 注解即可开启事务")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Student")]),a._v(" student"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("studentDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("student"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("如上加上 "),s("code",[a._v("Transactional")]),a._v(" 事务即被开启，当方法结束的时候会自动提交事务。我们一般在 Service 层添加事务，便于确保多个 DB 操作一起成功或失败。")]),a._v(" "),s("h2",{attrs:{id:"多数据源事务配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#多数据源事务配置"}},[a._v("#")]),a._v(" 多数据源事务配置")]),a._v(" "),s("p",[a._v("在配置了多数据源的情况下，我们需要对不同的数据源指定不同的事务管理器。")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Bean")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("name "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"testTransactionManager"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("DataSourceTransactionManager")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("testTransactionManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Qualifier")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"testDataSource"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("DataSource")]),a._v(" dataSource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("DataSourceTransactionManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("dataSource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("如上只需在数据源的配置类上加上事务管理器的 Bean 即可，然后在使用的时候指定使用的事务管理器即可。")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("value "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"testTransactionManager"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Student")]),a._v(" student"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("studentDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("student"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("h2",{attrs:{id:"配置事务隔离级别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置事务隔离级别"}},[a._v("#")]),a._v(" 配置事务隔离级别")]),a._v(" "),s("p",[a._v("MySQL 事务隔离级别共4种，Spring 中的 "),s("code",[a._v("org.springframework.transaction.annotation.Isolation")]),a._v(" 枚举提供了5种事务隔离级别设置，分别如下：")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("DEFAULT：默认值，表示使用底层数据库默认的隔离级别，大部分数据库的默认隔离级别都是 "),s("strong",[a._v("READ_COMMITTED")]),a._v("。")])]),a._v(" "),s("li",[s("p",[a._v("READ_UNCOMMITTED（读未提交）：可读取其他未提交的事务数据，无法防止脏读、不可重复读与幻读。")])]),a._v(" "),s("li",[s("p",[a._v("READ_COMMITTED（读已提交）：只能读取到其他已提交事务的数据，可以防止脏读。")])]),a._v(" "),s("li",[s("p",[a._v("REPEATABLE_READ（可重复读）：确保在一个事务中多次执行同样的数据查询操作结果都一致，可以防止脏读、不可重复读。")])]),a._v(" "),s("li",[s("p",[a._v("SERIALIZABLE（串行化）：确保事务串行执行，事务之间完全不会互相干扰，可防止脏读、不可重复读与幻读。")])])]),a._v(" "),s("p",[a._v("使用时设置 "),s("code",[a._v("Transactional")]),a._v(" 的事务级别即可：")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("isolation "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Isolation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("DEFAULT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])])]),s("h2",{attrs:{id:"配置事务传播行为"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置事务传播行为"}},[a._v("#")]),a._v(" 配置事务传播行为")]),a._v(" "),s("p",[a._v("因为在 JAVA 中可以定义多个事务，且如果方法之间互相调用，就可能存在多个事务重叠的情况，为了决定多个事务重叠的时候如何处理，Spring 中的 "),s("code",[a._v("org.springframework.transaction.annotation.Propagation")]),a._v(" 枚举提供了如下 7 种事务传播处理方式：")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("REQUIRED：如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。")])]),a._v(" "),s("li",[s("p",[a._v("SUPPORTS：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。")])]),a._v(" "),s("li",[s("p",[a._v("MANDATORY：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。")])]),a._v(" "),s("li",[s("p",[a._v("REQUIRES_NEW：创建一个新的事务，如果当前存在事务，则把当前事务挂起。")])]),a._v(" "),s("li",[s("p",[a._v("NOT_SUPPORTED：以非事务方式运行，如果当前存在事务，则把当前事务挂起。")])]),a._v(" "),s("li",[s("p",[a._v("NEVER：以非事务方式运行，如果当前存在事务，则抛出异常。")])]),a._v(" "),s("li",[s("p",[a._v("NESTED：如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于REQUIRED。")])])]),a._v(" "),s("p",[a._v("使用时设置 "),s("code",[a._v("Transactional")]),a._v(" 的传播级别即可：")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("REQUIRED"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])])]),s("h2",{attrs:{id:"错误回滚"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#错误回滚"}},[a._v("#")]),a._v(" 错误回滚")]),a._v(" "),s("p",[s("code",[a._v("Transactional")]),a._v(" 默认当捕捉到 "),s("code",[a._v("RuntimeException")]),a._v(" 与 "),s("code",[a._v("Error")]),a._v(" 时会自动回滚当前事务，如果需要所有异常发生时都回滚则可以添加 "),s("code",[a._v("rollbackFor = Exception.class")]),a._v("，如下：")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])])]),s("blockquote",[s("p",[a._v("切记，只有错误向上层抛出的时候才能触发错误回滚。如果你在方法中使用 "),s("code",[a._v("try catch")]),a._v(" 将异常给捕捉了，并没有继续向上层抛出的话，则不会触发错误回滚。")])]),a._v(" "),s("h2",{attrs:{id:"在单元测试中的应用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在单元测试中的应用"}},[a._v("#")]),a._v(" 在单元测试中的应用")]),a._v(" "),s("p",[a._v("我们在写单元测试的时候，往往希望在测试执行完成以后回滚测试过程中添加、修改或删除的数据，保持原样。这个时候就可以使用 "),s("code",[a._v("Transactional")]),a._v(" 注解，在测试类上加上 "),s("code",[a._v("Transactional")]),a._v(" 注解，可以让整个单元测试类中的方法在执行完成以后都回滚事务，如下：")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("DemoApplicationTests")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("如果我们只是想要某几个单元测试在执行完成以后回滚，也可以将 "),s("code",[a._v("Transactional")]),a._v(" 注解单独添加在方法上：")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Test")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("testTransactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("有时候我们可能也不想让所有的测试方法在执行完成以后都执行回滚操作，这时候我们可以在方法上添加 "),s("code",[a._v("@Rollback(false)")]),a._v(" 注解：")]),a._v(" "),s("div",{staticClass:"language-JAVA extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Transactional")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("DemoApplicationTests")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Test")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Rollback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("testTransactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[a._v("#")]),a._v(" 参考资料")]),a._v(" "),s("ol",[s("li",[s("a",{attrs:{href:"https://blog.csdn.net/dyc87112/article/details/107247780",target:"_blank",rel:"noopener noreferrer"}},[a._v("Spring Boot 2.x基础教程：事务管理入门"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=r.exports}}]);