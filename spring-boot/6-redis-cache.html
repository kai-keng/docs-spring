<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>整合Redis缓存 | Java</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Just record my learning process">
    <link rel="preload" href="/java-learning/assets/css/0.styles.dcc29016.css" as="style"><link rel="preload" href="/java-learning/assets/js/app.046a40f3.js" as="script"><link rel="preload" href="/java-learning/assets/js/2.cb888cbe.js" as="script"><link rel="preload" href="/java-learning/assets/js/3.512a63a5.js" as="script"><link rel="prefetch" href="/java-learning/assets/js/10.8638b991.js"><link rel="prefetch" href="/java-learning/assets/js/11.fa996cd1.js"><link rel="prefetch" href="/java-learning/assets/js/12.8ec6a2cc.js"><link rel="prefetch" href="/java-learning/assets/js/13.f596427d.js"><link rel="prefetch" href="/java-learning/assets/js/14.2549403a.js"><link rel="prefetch" href="/java-learning/assets/js/15.fe4a58bb.js"><link rel="prefetch" href="/java-learning/assets/js/16.7b8d367b.js"><link rel="prefetch" href="/java-learning/assets/js/17.d9dd8bfb.js"><link rel="prefetch" href="/java-learning/assets/js/18.502d2bd9.js"><link rel="prefetch" href="/java-learning/assets/js/19.cf055be3.js"><link rel="prefetch" href="/java-learning/assets/js/20.29650ce2.js"><link rel="prefetch" href="/java-learning/assets/js/21.37c7e0b2.js"><link rel="prefetch" href="/java-learning/assets/js/22.76f2ae5d.js"><link rel="prefetch" href="/java-learning/assets/js/23.4bc3d938.js"><link rel="prefetch" href="/java-learning/assets/js/24.24831809.js"><link rel="prefetch" href="/java-learning/assets/js/25.1a83af0d.js"><link rel="prefetch" href="/java-learning/assets/js/26.763cbe2a.js"><link rel="prefetch" href="/java-learning/assets/js/27.eef84ec1.js"><link rel="prefetch" href="/java-learning/assets/js/28.9fa67906.js"><link rel="prefetch" href="/java-learning/assets/js/29.a8bd1b7c.js"><link rel="prefetch" href="/java-learning/assets/js/30.fe1c1905.js"><link rel="prefetch" href="/java-learning/assets/js/31.c8c579ca.js"><link rel="prefetch" href="/java-learning/assets/js/32.76de8390.js"><link rel="prefetch" href="/java-learning/assets/js/33.b78dbf16.js"><link rel="prefetch" href="/java-learning/assets/js/34.d3cbc566.js"><link rel="prefetch" href="/java-learning/assets/js/35.9b64d0d8.js"><link rel="prefetch" href="/java-learning/assets/js/36.1f36f338.js"><link rel="prefetch" href="/java-learning/assets/js/37.6438e6a0.js"><link rel="prefetch" href="/java-learning/assets/js/38.e3396ab5.js"><link rel="prefetch" href="/java-learning/assets/js/39.8b644b85.js"><link rel="prefetch" href="/java-learning/assets/js/4.2ffd55ad.js"><link rel="prefetch" href="/java-learning/assets/js/40.1a0194ac.js"><link rel="prefetch" href="/java-learning/assets/js/5.4c0a6f56.js"><link rel="prefetch" href="/java-learning/assets/js/6.fe5c20c0.js"><link rel="prefetch" href="/java-learning/assets/js/7.68710204.js"><link rel="prefetch" href="/java-learning/assets/js/8.8a2a3006.js"><link rel="prefetch" href="/java-learning/assets/js/9.d83ea849.js">
    <link rel="stylesheet" href="/java-learning/assets/css/0.styles.dcc29016.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/java-learning/" class="home-link router-link-active"><!----> <span class="site-name">Java</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://kai-keng.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://kai-keng.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/spring-boot/" class="sidebar-heading clickable router-link-active open"><span>Spring Boot</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/java-learning/spring-boot/0-idea-configuration.html" class="sidebar-link">IDEA 相关配置介绍</a></li><li><a href="/java-learning/spring-boot/1-exception.html" class="sidebar-link">统一异常处理</a></li><li><a href="/java-learning/spring-boot/2-configuration.html" class="sidebar-link">配置文件实战</a></li><li><a href="/java-learning/spring-boot/3-mybatis-druid.html" class="sidebar-link">Spring Boot 整合Mybatis与Druid</a></li><li><a href="/java-learning/spring-boot/4-spring-multi-datasource.html" class="sidebar-link">Mybatis多数据源配置</a></li><li><a href="/java-learning/spring-boot/5-operation-log-aop.html" class="sidebar-link">AOP实现超简易的操作日志记录</a></li><li><a href="/java-learning/spring-boot/6-redis-cache.html" aria-current="page" class="active sidebar-link">整合Redis缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java-learning/spring-boot/6-redis-cache.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/java-learning/spring-boot/6-redis-cache.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/java-learning/spring-boot/6-redis-cache.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/java-learning/spring-boot/6-redis-cache.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/java-learning/spring-boot/10-hibernate-validator.html" class="sidebar-link">Spring 参数校验实战</a></li><li><a href="/java-learning/spring-boot/11-mybatis-auto.html" class="sidebar-link">Mybatis自动化便捷操作</a></li><li><a href="/java-learning/spring-boot/12-common-result.html" class="sidebar-link">包装通用控制层返回结果</a></li><li><a href="/java-learning/spring-boot/13-knife4j.html" class="sidebar-link">Spring Boot整合Knife4j</a></li></ul></section></li><li><a href="/java-learning/spring-cloud/" class="sidebar-link">Spring Cloud</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/mysql/" class="sidebar-heading clickable"><span>MySQL</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/java-learning/collection/" class="sidebar-link">集合框架</a></li><li><a href="/java-learning/jvm/" class="sidebar-link">JVM</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/multi-thread/" class="sidebar-heading clickable"><span>多线程</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java-learning/design-pattern/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/java-learning/internet/" class="sidebar-link">网络</a></li><li><a href="/java-learning/materials/" class="sidebar-link">相关资料</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="整合redis缓存"><a href="#整合redis缓存" class="header-anchor">#</a> 整合Redis缓存</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>缓存在我们业务中基本上属于必会的技能之一了，在业务中使用缓存的场景非常常见。因为缓存可以很好的帮助我们缓冲数据库的压力，利用好缓存可以让整个系统的并发能力大大提高，所以这篇文章简单介绍下Spring如何整合Redis缓存，并且使用Spring Cache中的注解简化我们的缓存操作。</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <ol><li>引入redis相关依赖</li></ol> <div class="language-XML extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><hr> <ol start="2"><li>在application.yml文件中添加redis相关配置</li></ol> <div class="language-YAML extra-class"><pre class="language-yaml"><code><span class="token key atrule">srping</span><span class="token punctuation">:</span>
  <span class="token comment"># redis数据库配置</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token comment"># Redis数据库索引（默认为0）</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token comment"># Redis服务器地址</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token comment"># Redis服务器连接端口</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token comment"># 连接超时时间（毫秒）</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token comment"># 连接池最大连接数（使用负值表示没有限制）</span>
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span>
      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">-1</span>
      <span class="token comment"># 连接池中的最大空闲连接</span>
      <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token comment"># 连接池中的最小空闲连接</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
</code></pre></div><hr> <ol start="3"><li>添加Redis配置类，基于Spring Boot 2.X</li></ol> <div class="language-JAVA extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableCaching</span> <span class="token comment">// 要开启必须要加上`@EnableCaching`注解，不添加的话不会开启缓存，也可以添加在启动类上</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token keyword">extends</span> <span class="token class-name">CachingConfigurerSupport</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SYMBOL_COLON <span class="token operator">=</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置类可以添加自定义的缓存key生成规则，只要如下实现即可，同时还可以定义多个KeyGenerator，针对不同的缓存名使用不同的生成规则，此处不作讲解</span>
<span class="token comment">//    @Override</span>
<span class="token comment">//    @Bean</span>
<span class="token comment">//    public KeyGenerator keyGenerator() {</span>
<span class="token comment">//        return (target, method, params) -&gt; {</span>
<span class="token comment">//            StringBuffer sb = new StringBuffer();</span>
<span class="token comment">////            sb.append(target.getClass().getName());</span>
<span class="token comment">////            sb.append(SYMBOL_COLON);</span>
<span class="token comment">//            sb.append(method.getName());</span>
<span class="token comment">//            sb.append(SYMBOL_COLON);</span>
<span class="token comment">//            for (Object obj : params) {</span>
<span class="token comment">//                sb.append(obj.toString());</span>
<span class="token comment">//            }</span>
<span class="token comment">//            return sb.toString();</span>
<span class="token comment">//        };</span>
<span class="token comment">//    }</span>

    <span class="token comment">// 自定义redis操作对象</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringRedisTemplate</span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置序列化工具，也可以不指定，默认存储的也是序列化以后的JSON，取出的时候也不需要自己去解析JSON，自动转化为POJO类</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect</span><span class="token punctuation">.</span><span class="token class-name">Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">LaissezFaireSubTypeValidator</span><span class="token punctuation">.</span>instance<span class="token punctuation">,</span>
            <span class="token class-name">ObjectMapper</span><span class="token punctuation">.</span><span class="token class-name">DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">,</span>
            <span class="token class-name">JsonTypeInfo</span><span class="token punctuation">.</span><span class="token class-name">As</span><span class="token punctuation">.</span>WRAPPER_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置缓存配置，比如缓存时间</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置缓存有效期一小时</span>
        <span class="token class-name">RedisCacheConfiguration</span> redisCacheConfiguration <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RedisCacheManager</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token class-name">RedisCacheWriter</span><span class="token punctuation">.</span><span class="token function">nonLockingRedisCacheWriter</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>redisCacheConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <ol start="4"><li>在需要缓存的类上添加缓存注解</li></ol> <div class="language-JAVA extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@CacheConfig</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token string">&quot;student&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StudentService</span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Student</span> student<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@CachePut</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;#student.sno&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Student</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Student</span> student<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;#sno&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">deleteBySno</span><span class="token punctuation">(</span><span class="token class-name">String</span> sno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;#sno&quot;</span><span class="token punctuation">,</span> unless <span class="token operator">=</span> <span class="token string">&quot;#result == null&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Student</span> <span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token class-name">String</span> sno<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>@CacheConfig</code>用于配置类中其他缓存配置的一些公共配置，比如类的默认缓存名称。也可以不使用改注解，在其他注解上自己单独配置。</p></li> <li><p><code>@Cacheable</code>用于表示调用该注解标识的方法时，会先去查询缓存，如果有则直接返回缓存，没有的话则调用方法，缓存方法的返回结果，可配置的主要参数有：</p> <p><strong>value、cacheNames</strong>：这两个参数意思等同，就是配置指定的缓存名称。</p> <p><strong>key</strong>：用于配置缓存的key值，实际最终的key值会是*[缓存名称]::[key]*。key配置的规则使用的是SpEL表达式来表示，比如<code>@Cacheable(key = &quot;#p0&quot;)</code>，<code>#p0</code>的意思是去第一个参数。</p> <p><strong>condition</strong>：配置是否缓存的条件，比如：<code>@Cacheable(key = &quot;#p0&quot;, condition = &quot;#p0.length() &lt; 3&quot;)</code>。</p> <p><strong>unless</strong>：这个不同于condition，它的调用时机是在方法调用完以后，可以获取到方法的结果来进行判断，比如：<code>@Cacheable(key = &quot;#sno&quot;, unless = &quot;#result == null&quot;)</code>,表示的是只有当结果不为null的时候才会被缓存，和我想的也不一样，我本来认为这样表示的为null的时候才缓存，实际测试结果刚好相反。</p> <p><strong>keyGenerator</strong>：用于指定key生成器，非必需。若需要指定一个自定义的key生成器，我们需要去实现org.springframework.cache.interceptor.KeyGenerator接口，并使用该参数来指定。</p> <p><strong>cacheManager</strong>：用于指定使用哪个缓存管理器，非必需。只有当有多个时才需要使用。</p> <p><strong>cacheResolver</strong>：用于指定使用那个缓存解析器，非必需。需通过org.springframework.cache.interceptor.CacheResolver接口来实现自己的缓存解析器，并用该参数指定。</p></li> <li><p><code>@CachePut</code>参数与<code>@Cacheable</code>都一样，区别在于<code>@CachePut</code>标识的方法一定是会被调用的，而且返回的结果会用于更新缓存，使用来更新缓存的。</p></li> <li><p><code>@CacheEvict</code>是用来标识需要删除缓存的方法，该注解会删除指定的缓存。它除了上面的参数以外还有2个额外的参数：</p> <p><strong>allEntries</strong>：非必需，默认为false。当为true时，会移除所有数据。</p> <p><strong>beforeInvocation</strong>：非必需，默认为false，会在调用方法之后移除数据。当为true时，会在调用方法之前移除数据。</p></li></ul> <hr> <ol start="5"><li>如上处理好了以后就可以开始测试了
测试前数据库数据：<img src="/java-learning/assets/img/cache-before-test-db.31b89885.jpg" alt="测试前数据库图"></li></ol> <p>测试代码：</p> <ol><li>测试查询2次</li></ol> <div class="language-JAVA extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首次查询001，直接查询数据库，并添加缓存</span>
    <span class="token class-name">Student</span> student1 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>student1<span class="token punctuation">,</span> <span class="token string">&quot;不为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第二次查询001，缓存中存在，查询缓存，不查询数据库</span>
    <span class="token class-name">Student</span> student2 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>student2<span class="token punctuation">,</span> <span class="token string">&quot;不为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：测试通过，数据库访问记录只有1条查询记录，缓存有1条。</p> <p>MySQL：
<img src="/java-learning/assets/img/cache-test-result-mysql-1.71bd830f.jpg" alt="MySQL">
Redis：
<img src="/java-learning/assets/img/cache-test-result-redis-1.87a86e08.jpg" alt="Redis"></p> <ol start="2"><li>测试更新数据同时更新缓存</li></ol> <div class="language-JAVA extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首次查询001，直接查询数据库，并添加缓存</span>
    <span class="token class-name">Student</span> student1 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>student1<span class="token punctuation">,</span> <span class="token string">&quot;不为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第二次查询001，缓存中存在，查询缓存，不查询数据库</span>
    <span class="token class-name">Student</span> student2 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>student2<span class="token punctuation">,</span> <span class="token string">&quot;不为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>student2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;KangKang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;名称等于KangKang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新001，同步更新缓存</span>
    <span class="token class-name">Student</span> student3 <span class="token operator">=</span> <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sno</span><span class="token punctuation">(</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;XiaoKang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sex</span><span class="token punctuation">(</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    studentService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>student3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第三次查询缓存，缓存已更新</span>
    <span class="token class-name">Student</span> student4 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>student4<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;XiaoKang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;名称等于XiaoKang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：测试通过，数据库访问记录有2条，一条查询记录一条更新记录。缓存有1条，内容为已更新内容。</p> <p>MySQL：
<img src="/java-learning/assets/img/cache-test-result-mysql-2.dbec46e3.jpg" alt="MySQL">
Redis：
<img src="/java-learning/assets/img/cache-test-result-redis-2.de6db6fb.jpg" alt="Redis"></p> <ol start="3"><li>测试新增数据并删除，缓存也删除</li></ol> <div class="language-JAVA extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加新的数据</span>
    <span class="token class-name">Student</span> student5 <span class="token operator">=</span> <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sno</span><span class="token punctuation">(</span><span class="token string">&quot;004&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;Borg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sex</span><span class="token punctuation">(</span><span class="token string">&quot;M&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    studentService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>student5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 首次查询004，查询数据库，添加进缓存</span>
    <span class="token class-name">Student</span> student6 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;004&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>student6<span class="token punctuation">,</span> <span class="token string">&quot;不为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第二次查询004，查询缓存</span>
    <span class="token class-name">Student</span> student7 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;004&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>student7<span class="token punctuation">,</span> <span class="token string">&quot;不为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除缓存</span>
    studentService<span class="token punctuation">.</span><span class="token function">deleteBySno</span><span class="token punctuation">(</span><span class="token string">&quot;004&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第三次查询004，缓存中不存在，查询数据库，结果为null，不添加进缓存</span>
    <span class="token class-name">Student</span> student8 <span class="token operator">=</span> studentService<span class="token punctuation">.</span><span class="token function">queryStudentBySno</span><span class="token punctuation">(</span><span class="token string">&quot;004&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>student8<span class="token punctuation">,</span> <span class="token string">&quot;为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：测试通过，数据库访问记录有3条，两条查询记录，一条删除记录。缓存0条，被删除且最终null值不缓存。</p> <p>MySQL：
<img src="/java-learning/assets/img/cache-test-result-mysql-3.692c9c2c.jpg" alt="MySQL">
Redis：
<img src="/java-learning/assets/img/cache-test-result-redis-3.7bd61ab8.jpg" alt="Redis"></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>Spring整合Redis的关键点在于实现好Redis配置类，在配置类中可以做一些自定义的配置。在实际业务中，需要准确的选择好需要缓存的服务和缓存时间，缓存的条件也是关键，配合上注解，可以很容易的处理好缓存。缓存是一门可以深耕的内容，在生产中缓存的场景往往会复杂很多，我们还需要应对很多缓存的问题，比如缓存雪崩，缓存穿透等，这些以后再抽单独的篇章来讲解，学好缓存是后端的必修课。</p> <p>在实现的过程中还碰到一个问题，就是使用<code>@CachePut</code>注解的时候，方法的返回值得准确，注解会使用方法的返回值更新缓存。我开始更新方法返回的是更新的条数，Integer类型，然后在查询的时候反序列化过程直接抛出<code>java.lang.ClassCastException</code>，反序列化失败。在更新方法中返回更新以后查询的新值就好了，这点需要注意下。</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ol><li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#cache" target="_blank" rel="noopener noreferrer">SpEL表达式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html#REDIS" target="_blank" rel="noopener noreferrer">Spring Boot Redis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mrbird.cc/Spring-Boot%20cache.html" target="_blank" rel="noopener noreferrer">参考文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java-learning/spring-boot/5-operation-log-aop.html" class="prev">
        AOP实现超简易的操作日志记录
      </a></span> <span class="next"><a href="/java-learning/spring-boot/10-hibernate-validator.html">
        Spring 参数校验实战
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/java-learning/assets/js/app.046a40f3.js" defer></script><script src="/java-learning/assets/js/2.cb888cbe.js" defer></script><script src="/java-learning/assets/js/3.512a63a5.js" defer></script>
  </body>
</html>
